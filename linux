#!/bin/bash

# Configurable variables
MAX_RETRIES=5
RETRY_COUNT=0
PASSWORD_RETRIEVED=0
OUT=""

echo "EndDBatch properties for CyberArk:"
echo "APPID: $APPID"
echo "SAFE: $SAFE"
echo "OBJECT: $OBJECT"
echo "REASON: $REASON"

while [ $PASSWORD_RETRIEVED -eq 0 ] && [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    OUT=$(
        
    )

    if [ $? -eq 0 ]; then
        if [ "$OUT" != "APPAP282E: 11" ]; then
            PASSWORD_RETRIEVED=1
            break
        else
            echo "Invalid password content, retrying..."
            sleep 3
        fi
    else
        echo "Command failed, retrying..."
        sleep 3
    fi

    RETRY_COUNT=$((RETRY_COUNT + 1))
done

if [ $PASSWORD_RETRIEVED -eq 0 ]; then
    echo "Password retrieval via CyberArk: FAILED after $MAX_RETRIES attempts."
    echo "Reason: $OUT"
    exit 1
else
    echo "Password retrieval via CyberArk: SUCCESS."
    export UPWD="$OUT"
fi
