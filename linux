#!/bin/bash

# List of Git repo URLs
REPOS=(
  "git@github.com:your-org/service-a.git"
  "git@github.com:your-org/service-b.git"
)

BRANCHES=("sit-release" "main")
PREFIX="c"

for REPO in "${REPOS[@]}"; do
  # Extract service name from repo name
  SERVICE=$(basename "$REPO" .git)

  for BRANCH in "${BRANCHES[@]}"; do
    FOLDER="${PREFIX}.${SERVICE}"  # clone target folder is fixed per service
    TEMP_FOLDER="${FOLDER}-${BRANCH}"  # unique working copy per branch

    echo "üîÑ Cloning [$BRANCH] of $SERVICE into $TEMP_FOLDER..."
    git clone --single-branch --branch "$BRANCH" "$REPO" "$TEMP_FOLDER"

    cd "$TEMP_FOLDER" || exit 1

    if [ -d "$SERVICE" ]; then
      echo "üì¶ Moving contents from inner '$SERVICE' to project root..."

      # Include hidden files like .env or .gitignore
      shopt -s dotglob
      mv "$SERVICE"/* ./
      rm -rf "$SERVICE"
      shopt -u dotglob

      # Commit and push the changes
      git add .
      git commit -m "Flatten structure: moved '$SERVICE/' contents to root"
      git push origin "$BRANCH"

      echo "‚úÖ Changes pushed for $SERVICE [$BRANCH]"
    else
      echo "‚ö†Ô∏è Inner folder '$SERVICE' not found in $TEMP_FOLDER ‚Äî skipping flattening"
    fi

    cd ..
    rm -rf "$TEMP_FOLDER"  # Optional: clean up cloned folder after push
  done
done

echo "üéâ All service branches processed and updated."
