#!/bin/bash

# Login to OpenShift cluster (replace USER_NAME and PASSWORD)
oc login URL -u [USER_NAME] -p [PASSWORD] --insecure-skip-tls-verify=true > /dev/null

# Output file
output_file="/home/SOEID/scripts/pods_data.html"

# Start HTML
cat <<EOF > "$output_file"
<html>
<head><style>
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #ddd; padding: 8px; }
th { background-color: #f2f2f2; }
</style></head>
<body>
<h3>Production PODs Status Report</h3>
<table>
<tr><th>Name</th><th>Ready</th><th>Status</th><th>Restarts</th><th>Age</th></tr>
EOF

# Append pod data
oc get pods --no-headers | grep Running | awk '{print "<tr><td>"$1"</td><td>"$2"</td><td>"$3"</td><td>"$4"</td><td>"$5"</td></tr>"}' >> "$output_file"

# End table and add image section
echo "</table><br><h4>Image Versions Used</h4><ul>" >> "$output_file"

# Get image versions
for pod in $(oc get pods --no-headers | grep Running | awk '{print $1}'); do
  image=$(oc describe pod "$pod" | grep 'Image:' | head -1 | awk '{print $2}')
  echo "<li><b>$pod</b>: $image</li>" >> "$output_file"
done

# End HTML
echo "</ul></body></html>" >> "$output_file"

# Send mail in HTML format
subject="ECS_ALERT: PRODUCTION PODS STATUS"
to=""
from="ECSDeployment_"

cat "$output_file" | mailx -a "Content-Type: text/html" -s "$subject" -r "$from" $to

# Logout
oc logout > /dev/null
