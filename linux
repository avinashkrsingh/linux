#!/bin/bash

NAMESPACE="my-namespace"  # Replace with your OpenShift project name
DEPLOYMENT_NAME="my-app"  # Replace with your deployment name
EMAIL_TO="team@example.com"
EMAIL_SUBJECT="ðŸš€ OpenShift Deployment Successful - All Pods Are Running"

# Function to check if all pods are running
check_pods_status() {
  while true; do
    # Count the total number of pods
    TOTAL_PODS=$(oc get pods -n $NAMESPACE -l app=$DEPLOYMENT_NAME --no-headers | wc -l)
    # Count how many pods are in "Running" state
    RUNNING_PODS=$(oc get pods -n $NAMESPACE -l app=$DEPLOYMENT_NAME --no-headers | grep "Running" | wc -l)
    
    echo "Total Pods: $TOTAL_PODS, Running Pods: $RUNNING_PODS"
    
    # If all pods are running, send the email
    if [ "$TOTAL_PODS" -eq "$RUNNING_PODS" ] && [ "$TOTAL_PODS" -gt 0 ]; then
      send_email
      break
    fi

    sleep 10  # Check every 10 seconds
  done
}

# Function to send email
send_email() {
  echo "Sending email notification..."
  
  EMAIL_BODY=$(cat <<EOF
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f5f5; }
    .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0px 0px 10px #aaa; }
    h2 { color: #0033a0; }
    .status { color: green; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h2>âœ… OpenShift Deployment Successful!</h2>
    <p>The deployment <b>$DEPLOYMENT_NAME</b> in <b>$NAMESPACE</b> is now complete.</p>
    <p>All pods are in <span class="status">Running</span> state.</p>
    <p>ðŸš€ You can now access the application.</p>
    <br>
    <p>Best Regards,</p>
    <p><b>DevOps Team</b></p>
  </div>
</body>
</html>
EOF
  )

  echo "$EMAIL_BODY" | mailx -a "Content-Type: text/html" -s "$EMAIL_SUBJECT" "$EMAIL_TO"
}

# Start monitoring pods
check_pods_status
